<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8" />
    <title th:text="${post.title} + ' - 게시글 상세보기'">게시글 상세보기</title>

    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/post-detail.css" />
    <link rel="stylesheet" href="/css/interview-result.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body data-page="detail"
      th:attr="data-post-id=${post.id},
               data-current-user-id=${#authorization.expression('isAuthenticated()') ? #authentication.principal.userId : null},
               data-current-username=${#authorization.expression('isAuthenticated()') ? #authentication.name : null},
               data-current-user-email=${#authorization.expression('isAuthenticated()') ? #authentication.name : ''}">


<div th:replace="~{fragments/header :: header}"></div>

<main class="main-container">
    <div class="post-detail-card" th:attr="data-post-id=${post.id}">

        <header class="post-header">
            <img class="profile-img" th:src="@{/img/profile-default.svg}" alt="프로필" />
            <div class="user-info">
                <span class="username" th:text="${post.username}">testuser</span>
                <span class="post-date"
                      th:text="${post.createdAt != null ? #temporals.format(post.createdAt, 'yyyy-MM-dd') : ''}">
                  2025-08-08
                </span>
            </div>
        </header>

        <h2 class="post-title" th:text="${post.title}">게시글 제목</h2>

        <div class="post-extra" th:if="${post.interviewResultId != null}">
            <hr class="meta-divider" />
            <div class="extra-row">
                <strong>인터뷰 결과 ID</strong>
                <span th:text="${post.interviewResultId}">123</span>
            </div>
        </div>

        <section class="result-container"
                 id="interview-result-embed"
                 th:if="${post.interviewResultId != null}"
                 th:attr="data-interview-id=${post.interviewResultId}">
            <div class="result-header">
                <h1>면접이 완료되었습니다!</h1>
                <p>수고하셨습니다. 면접 결과를 확인해보세요.</p>
            </div>

            <div class="result-card">
                <div class="score-summary">
                    <h2><span id="total-score">--</span>/100</h2>
                    <div id="grade" class="grade-badge">Grade --</div>
                </div>

                <div class="skill-scores">
                    <div class="skill-item">
                        <div class="label"><span>기술적 지식</span><span id="skill-tech-score">0%</span></div>
                        <div class="progress-bar"><div class="progress" id="skill-tech-progress"></div></div>
                    </div>
                    <div class="skill-item">
                        <div class="label"><span>문제 해결 능력</span><span id="skill-problem-score">0%</span></div>
                        <div class="progress-bar"><div class="progress" id="skill-problem-progress"></div></div>
                    </div>
                    <div class="skill-item">
                        <div class="label"><span>의사소통 능력</span><span id="skill-comm-score">0%</span></div>
                        <div class="progress-bar"><div class="progress" id="skill-comm-progress"></div></div>
                    </div>
                    <div class="skill-item">
                        <div class="label"><span>태도 & 열정</span><span id="skill-attitude-score">0%</span></div>
                        <div class="progress-bar"><div class="progress" id="skill-attitude-progress"></div></div>
                    </div>
                </div>

                <h3 class="section-title">상세 피드백</h3>
                <div id="feedback-text" class="feedback-details">Loading...</div>

                <h3 class="section-title">종합 평가</h3>
                <div id="summary-text" class="summary-details">Loading...</div>
            </div>
        </section>

        <script th:if="${post.interviewResultId != null}" th:inline="javascript">
            window.INTERVIEW_RESULT_ID = [[${post.interviewResultId}]];
        </script>

        <script th:if="${post.interviewResultId != null}" th:inline="javascript">
            (function () {
              var id = [[${post.interviewResultId}]];
              var parts = window.location.pathname.split('/');
              var last = parts[parts.length - 1];
              if (!/^\d+$/.test(last)) {
                history.replaceState(null, '', window.location.pathname.replace(/\/$/, '') + '/' + id);
              }
            })();
        </script>

        <script th:if="${post.interviewResultId != null}" th:src="@{/js/interview-result.js}"></script>

        <section class="extra-memo">
            <h3 class="extra-title">추가 메모</h3>
            <div class="extra-body">
                <div class="post-content"
                     th:text="${#strings.defaultString(post.content, '')}"></div>
            </div>
        </section>

        <div class="post-actions"
             th:if="${#authorization.expression('isAuthenticated()') and post.userId == #authentication?.principal?.userId}">
            <button id="btn-edit-post"  class="btn-action">수정</button>
            <button id="btn-delete-post" class="btn-action btn-danger">삭제</button>
        </div>

        <div class="post-footer">
            <div class="metrics">
                <div class="metric">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i>
                    <span id="view-count" class="count" th:text="${post.viewCount}">0</span>
                </div>

                <button type="button"
                        class="btn-icon btn-like"
                        th:classappend="${post.liked} ? ' is-active' : ''"
                        data-post-id="[[${post.id}]]"
                        th:data-url="@{/api/community/posts/{id}/like(id=${post.id})}">
                    <i class="fa-solid fa-heart" aria-hidden="true"></i>
                    <span class="count" th:text="${post.likeCount}">0</span>
                </button>

                <button type="button"
                        class="btn-icon btn-scrap"
                        th:classappend="${post.bookmarked} ? ' is-active' : ''"
                        data-post-id="[[${post.id}]]"
                        th:data-url="@{/api/community/posts/{id}/scrap(id=${post.id})}">
                    <i class="fa-regular fa-bookmark" aria-hidden="true"></i>
                    <span class="count" th:text="${post.scrapCount}">0</span>
                </button>
            </div>
            <hr class="meta-divider" />
        </div>

        <section class="comments-section">
            <div class="comments">
                <div class="comments__title">
                    <span>댓글</span>
                    <span class="comments__badge">
                        <span id="comment-count"
                              th:text="${comments != null ? #lists.size(comments) : 0}">0</span>개
                    </span>
                </div>

                <form id="comment-form" class="comment-form" onsubmit="return false;">
                    <textarea id="comment-input" name="content" placeholder="댓글을 입력하세요..." required></textarea>
                    <button id="comment-submit" type="button" class="btn-submit"
                            th:disabled="${#authorization.expression('!isAuthenticated()')}">등록</button>
                </form>

                <ul id="comment-list" class="comment-list"></ul>
                <button id="comment-load-more" type="button" style="display:none">더보기</button>
            </div>
        </section>

        <div class="post-detail__nav">
            <a th:href="@{/community}" id="btn-back-to-list">
                <i class="fa fa-list-ul" aria-hidden="true"></i>
                목록
            </a>
        </div>
    </div>
</main>

<script src="/js/spinner.js"></script>
<div th:replace="~{fragments/loading-spinner :: spinner}"></div>

<script>
    (function(){
      const d = document.body.dataset;
      window.POST_ID            = d.postId ? Number(d.postId) : null;
      window.CURRENT_USER_ID    = d.currentUserId ? Number(d.currentUserId) : null;
      window.CURRENT_USERNAME   = d.currentUsername || null;
      window.CURRENT_USER_EMAIL = d.currentUserEmail || null;
    })();
</script>

<div id="recommendations-text" style="display:none"></div>

<script>
    window.escapeHtml = function (s) {
      if (s == null) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    };
</script>

<script th:src="@{/js/post-detail-comments.js}" defer></script>
</body>
</html>
