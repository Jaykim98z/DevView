<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>마이페이지</title>
    <!-- CSRF 토큰 메타 태그 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" th:href="@{/css/mypage.css}" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <script th:src="@{/js/lib/chart.min.js}"></script>
    <script defer th:src="@{/js/mypage.js}"></script>
</head>
<body>
<!-- 헤더 -->
<th:block th:replace="~{fragments/header :: header}"></th:block>

<div class="mypage-container">

    <!-- 상단 인사 -->
    <h1><strong>마이페이지</strong></h1>
    <h2 class="greeting" th:text="'안녕하세요, ' + ${user.name} + '님!'">안녕하세요, 사용자님!</h2>

    <div class="profile-layout">
        <div class="left-column">
            <!-- 프로필 카드 -->
            <div class="profile-card">
                <div class="profile-image">
                    <img th:if="${user.profileImageUrl != null}" th:src="@{${user.profileImageUrl}}" alt="프로필" />
                    <img th:if="${user.profileImageUrl == null}" src="/img/진욱.svg" alt="기본 이미지" />
                    <br>
                    <h2 class="name" th:text="${user.name}">이름</h2>
                    <p class="job-level" th:text="${user.job + ', ' + user.careerLevel}">백엔드개발, 주니어 레벨</p>
                </div>

                <!-- 통계 -->
                <div class="stats">
                    <div><strong th:text="${user.totalInterviews}">0</strong><span>면접 횟수</span></div>
                    <div><strong th:text="${user.avgScore}">0</strong><span>평균 점수</span></div>
                    <div><strong th:text="${user.grade != null ? user.grade : 'F'}">F</strong><span>최종 등급</span></div>
                </div>

                <!-- 액션 버튼 -->
                <div class="actions">
                    <form th:action="@{/mypage/edit}" method="get">
                        <button type="submit" class="btn">
                            <img src="/img/edit.svg" class="icon" alt="프로필 수정" />
                            프로필 수정
                        </button>
                    </form>
                    <form th:action="@{/mypage/delete}" method="post" id="withdrawalForm">
                        <!-- CSRF 토큰 히든 필드 추가 -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn danger">
                            <img src="/img/bye.svg" class="icon" alt="회원 탈퇴" />
                            회원 탈퇴
                        </button>
                    </form>
                </div>
            </div>

            <!-- 계정 설정 카드 -->
            <div class="account-card">
                <div class="card-title">
                    <img src="/img/set.svg" class="icon" alt="계정 설정" />
                    <h3>계정 설정</h3>
                </div>
                <p class="kv"><span class="k">이메일</span><span class="v" th:text="${user.email}">example@example.com</span></p>
                <p class="kv"><span class="k">비밀번호</span><span class="v"><a th:href="@{/mypage/edit}" class="text-link">변경하기</a></span></p>
                <p class="kv"><span class="k">가입일</span><span class="v" th:text="${user.joinedAt != null ? #temporals.format(user.joinedAt, 'yyyy.MM.dd') : '-'}">YYYY.MM.DD</span></p>
            </div>
        </div>

        <div class="right-column">
            <!-- 점수 변화 그래프 -->
            <div class="graph-card">
                <div class="card-title">
                    <img src="/img/graps.svg" class="icon" alt="점수 변화 그래프"/>
                    <h3>점수 변화 그래프</h3>
                </div>
                <canvas id="scoreChart"
                        th:attr="data-labels=${scoreGraph.labelsJson}, data-scores=${scoreGraph.scoresJson}">
                </canvas>
            </div>

            <!-- 면접 목록  -->
            <section class="interview-history">
                <div class="section-title">
                    <img src="/img/interviewslist.svg" class="icon" alt="나의 면접 목록"/>
                    <h3>나의 면접 목록</h3>
                </div>
                <ul>
                    <li th:each="interview : ${user.interviews}">
                        <div class="interview-item">
                            <div class="row">
                                <div class="chips">
                                    <span class="chip chip-date"
                                          th:text="${interview.interviewDate != null ? interview.interviewDate : ''}">YYYY-MM-DD</span>
                                    <span class="chip chip-type" th:text="${interview.interviewType}">직무</span>
                                </div>
                                <div class="score-wrap">
                                    <span class="score" th:text="${interview.score + '점'}">0점</span>
                                    <span class="grade" th:text="${interview.grade}">-</span>
                                </div>
                            </div>
                            <p class="feedback" th:text="${interview.feedback}">피드백</p>
                        </div>
                    </li>
                </ul>
            </section>

            <!-- 스크랩 목록 -->
            <section class="scrap-section">
                <div class="section-title">
                    <img src="/img/scrap.svg" class="icon" alt="스크랩 목록"/>
                    <h3>스크랩 목록</h3>
                </div>
                <ul>
                    <li th:each="scrap : ${user.scraps}">
                        <a th:href="${scrap.link}" target="_blank" rel="noopener noreferrer" class="scrap-item">
                            <h4 th:text="${scrap.title}">제목</h4>
                            <div class="meta">
                                <span>❤️ <span th:text="${scrap.likes}">0</span></span>
                                <span>💬 <span th:text="${scrap.comments}">0</span></span>
                            </div>
                        </a>
                    </li>
                </ul>
            </section>
        </div>
    </div>
</div>
</body>
</html>
