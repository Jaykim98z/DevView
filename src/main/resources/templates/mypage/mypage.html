<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>마이페이지</title>
    <!-- CSRF 토큰 메타 태그 추가 -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" th:href="@{/css/mypage.css}" />
    <link rel="stylesheet" th:href="@{/css/header.css}" />
    <link rel="stylesheet" th:href="@{/css/password-change.css}" />
    <!-- Chart.js (이미 포함) -->
    <script th:src="@{/js/lib/chart.min.js}"></script>
    <!-- 통합 JS -->
    <script defer th:src="@{/js/mypage.js}"></script>
    <!-- 비밀번호 변경 JS -->
    <script defer th:src="@{/js/password-change.js}"></script>
</head>
<body>
<!-- 헤더 -->
<th:block th:replace="~{fragments/header :: header}"></th:block>

<div class="mypage-container">

    <!-- 상단 인사 -->
    <h1><strong>마이페이지</strong></h1>
    <h2 class="greeting" th:text="'안녕하세요, ' + ${user.name} + '님!'">안녕하세요, 사용자님!</h2>

    <div class="profile-layout">
        <div class="left-column">
            <!-- 프로필 카드 -->
            <div class="profile-card">
                <div class="profile-image">
                    <img th:if="${user.profileImageUrl != null}" th:src="@{${user.profileImageUrl}}" alt="프로필" />
                    <img th:if="${user.profileImageUrl == null}" src="/img/진욱.svg" alt="기본 이미지" />
                    <br>
                    <h2 class="name" th:text="${user.name}">이름</h2>
                    <p class="job-level" th:text="${user.job + ', ' + user.careerLevel}">백엔드개발, 주니어 레벨</p>
                </div>

                <!-- 통계 (ID 추가) -->
                <div class="stats">
                    <div><strong id="interviewCount" th:text="${user.totalInterviews}">0</strong><span>면접 횟수</span></div>
                    <div><strong id="avgScore" th:text="${user.avgScore}">0</strong><span>평균 점수</span></div>
                    <div><strong id="bestGrade" th:text="${user.grade != null ? user.grade : 'F'}">F</strong><span>최종 등급</span></div>
                </div>

                <!-- 액션 버튼 -->
                <div class="actions">
                    <form th:action="@{/mypage/edit}" method="get">
                        <button type="submit" class="btn">
                            <img src="/img/edit.svg" class="icon" alt="프로필 수정" />
                            프로필 수정
                        </button>
                    </form>
                    <form th:action="@{/mypage/delete}" method="post" id="withdrawalForm">
                        <!-- CSRF 토큰 히든 필드 추가 -->
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <button type="submit" class="btn danger">
                            <img src="/img/bye.svg" class="icon" alt="회원 탈퇴" />
                            회원 탈퇴
                        </button>
                    </form>
                </div>
            </div>

            <!-- 계정 설정 카드 -->
            <div class="account-card">
                <div class="card-title">
                    <img src="/img/set.svg" class="icon" alt="계정 설정" />
                    <h3>계정 설정</h3>
                </div>
                <p class="kv"><span class="k">이메일</span><span class="v" th:text="${user.email}">example@example.com</span></p>
                <p class="kv"><span class="k">비밀번호</span><span class="v"><button type="button" id="changePasswordBtn" class="text-link-btn">변경하기</button></span></p>
                <p class="kv"><span class="k">가입일</span><span class="v" th:text="${user.joinedAt != null ? #temporals.format(user.joinedAt, 'yyyy.MM.dd') : '-'}">YYYY.MM.DD</span></p>
            </div>
        </div>

        <div class="right-column">
            <!-- 점수 변화 그래프 -->
            <div class="graph-card">
                <div class="card-title">
                    <img src="/img/graps.svg" class="icon" alt="점수 변화 그래프"/>
                    <h3>점수 변화 그래프</h3>
                </div>
                <canvas id="scoreChart"
                        th:attr="data-labels=${scoreGraph != null ? scoreGraph.labelsJson : null},
                                 data-scores=${scoreGraph != null ? scoreGraph.scoresJson : null}">
                </canvas>
            </div>
            <!-- 면접 목록  -->
            <section class="interview-history">
                <div class="section-title">
                    <img src="/img/interviewslist.svg" class="icon" alt="나의 면접 목록"/>
                    <h3>나의 면접 목록</h3>
                </div>
                <ul id="interviewList">
                    <li th:each="interview : ${user.interviews}">
                        <div class="interview-item">
                            <div class="row">
                                <div class="chips">
                                    <span class="chip chip-type" th:text="${interview.jobPositionDisplayName}">직무</span>
                                    <span class="chip chip-level" th:text="${interview.careerLevelDisplayName}">레벨</span>
                                    <span class="chip chip-type" th:text="${interview.interviewType}">면접타입</span>
                                    <span class="chip chip-date"
                                          th:text="${interview.interviewDate != null ? interview.interviewDate : ''}">YYYY-MM-DD</span>
                                </div>
                                <div class="score-wrap">
                                    <span class="score" th:text="${interview.score + '점'}">0점</span>
                                    <span class="grade" th:text="${interview.grade + '등급'}">-</span>
                                </div>
                            </div>
                            <a class="btn small" th:href="${interview.detailUrl}">상세 보기</a>
                        </div>
                    </li>
                </ul>
            </section>
            <!-- 스크랩 목록 -->
            <section class="scrap-section">
                <div class="section-title">
                    <img src="/img/scrap.svg" class="icon" alt="스크랩 목록"/>
                    <h3>스크랩 목록</h3>
                </div>

                <ul id="scrapList" class="scrap-grid">
                    <li th:each="scrap : ${user.scraps}"
                        th:with="isExternal=${#strings.startsWith(scrap.link,'http')}">

                        <!-- 링크: 컨텍스트 경로 보정(@{...}) + 외부/내부에 따라 target/rel 분기 -->
                        <a th:href="@{${scrap.link}}"
                           th:attr="target=${isExternal ? '_blank' : null},
                  rel=${isExternal ? 'noopener noreferrer' : null}"
                           class="scrap-item">
                            <h4 class="scrap-title" th:text="${scrap.title}">제목</h4>
                            <p class="scrap-desc" th:text="${scrap.preview}">요약 내용</p>
                            <div class="scrap-meta">
                                <span class="writer">👤 <span th:text="${scrap.writerName}">작성자</span></span>
                                <span class="likes">❤️ <span th:text="${scrap.likes}">0</span></span>
                            </div>
                        </a>
                    </li>
                    <!-- 스크랩이 비어있을 때 메시지 (옵션) -->
                    <li th:if="${#lists.isEmpty(user.scraps)}" class="empty">
                        아직 스크랩이 없습니다.
                    </li>
                </ul>
            </section>
        </div>
    </div>
</div>

<!-- 비밀번호 변경 모달 -->
<div id="passwordChangeModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>비밀번호 변경</h3>
            <button type="button" id="closeModalBtn" class="close-btn">&times;</button>
        </div>

        <form id="passwordChangeForm" class="modal-body">
            <!-- 현재 비밀번호 -->
            <div class="form-group">
                <label for="currentPassword" class="form-label">현재 비밀번호</label>
                <div class="input-group">
                    <input
                            type="password"
                            id="currentPassword"
                            name="currentPassword"
                            class="form-input"
                            placeholder="현재 비밀번호를 입력해주세요"
                            maxlength="20"
                            required
                    >
                    <button type="button" class="password-toggle" data-target="currentPassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="error-message" id="currentPasswordError"></div>
            </div>

            <!-- 새 비밀번호 -->
            <div class="form-group">
                <label for="newPassword" class="form-label">새 비밀번호</label>
                <div class="input-group">
                    <input
                            type="password"
                            id="newPassword"
                            name="newPassword"
                            class="form-input"
                            placeholder="새 비밀번호를 입력해주세요 (8자 이상)"
                            maxlength="20"
                            required
                    >
                    <button type="button" class="password-toggle" data-target="newPassword">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="form-hint">영문, 숫자, 특수문자를 포함하여 8자 이상 입력해주세요</div>
                <div class="password-strength" id="passwordStrength">
                    <span class="strength-text">보통</span>
                    <div class="strength-bar">
                        <div class="strength-fill" id="strengthFill"></div>
                    </div>
                </div>
                <div class="error-message" id="newPasswordError"></div>
                <div class="success-message" id="newPasswordSuccess"></div>
            </div>

            <!-- 새 비밀번호 확인 -->
            <div class="form-group">
                <label for="newPasswordConfirm" class="form-label">새 비밀번호 확인</label>
                <div class="input-group">
                    <input
                            type="password"
                            id="newPasswordConfirm"
                            name="newPasswordConfirm"
                            class="form-input"
                            placeholder="새 비밀번호를 다시 입력해주세요"
                            maxlength="20"
                            required
                    >
                    <button type="button" class="password-toggle" data-target="newPasswordConfirm">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div class="error-message" id="newPasswordConfirmError"></div>
                <div class="success-message" id="newPasswordConfirmSuccess"></div>
            </div>
        </form>

        <div class="modal-footer">
            <button type="button" id="cancelBtn" class="btn btn-secondary">취소</button>
            <button type="submit" form="passwordChangeForm" id="submitBtn" class="btn btn-primary" disabled>
                비밀번호 변경
            </button>
        </div>
    </div>
</div>


</body>
</html>
